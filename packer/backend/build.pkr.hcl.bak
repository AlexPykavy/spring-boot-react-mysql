packer {
  required_plugins {
    googlecompute = {
      version = ">= 1.1.1"
      source = "github.com/hashicorp/googlecompute"
    }
  }
}

variable "project_id" {
  type = string
}

variable "zone" {
  type = string
}

variable "ssh_username" {
  type = string
}

source "googlecompute" "test-image" {
  project_id                  = var.project_id
  zone                        = var.zone
  # credentials_json            = file("service-account.json")

  source_image_family         = "debian-12"
  image_description           = "Image for bezkoder's spring-boot-react-mysql backend"
  ssh_username                = var.ssh_username
  tags                        = ["packer"]

  image_name                  = "bezkoder-backend-{{timestamp}}"
  instance_name               = "pkr-bezkoder-backend-{{uuid}}"
}

build {
  sources = ["sources.googlecompute.test-image"]

  provisioner "shell" {
    inline = [
      "wget https://dev.mysql.com/get/mysql-apt-config_0.8.30-1_all.deb",
      "sudo -E dpkg -i mysql-apt-config_0.8.30-1_all.deb",
      "sudo -E apt update",
      "sudo -E apt install git maven mysql-server -y",
    ]
    environment_vars = [
      "DEBIAN_FRONTEND=noninteractive"
    ]
  }

  provisioner "shell" {
    inline = [
      "sudo useradd -m -d /opt/bezkoder-backend -s /bin/bash backend"
    ]
  }

  provisioner "shell" {
    inline = [
      "echo 'mysql_native_password=ON' | sudo tee -a /etc/mysql/mysql.conf.d/mysqld.cnf",
      "sudo systemctl restart mysql",
      "sudo mysql -u root -e \"CREATE DATABASE testdb;\"",
      "sudo mysql -u root -e \"ALTER USER 'root'@'localhost' IDENTIFIED WITH 'mysql_native_password ' BY '123456';\"",
    ]
  }

  // provisioner "shell" {
  //   inline = [
  //     "sudo mysql -u root -e \"CREATE DATABASE testdb;\"",
  //     "sudo mysql -u root -e \"ALTER USER 'root'@'localhost' IDENTIFIED WITH 'caching_sha2_password ' BY '123456';\"",
  //     # append allowPublicKeyRetrieval=true to the connection string
  //   ]
  // }

  provisioner "shell" {
    inline = [
      "git clone https://github.com/bezkoder/spring-boot-react-mysql.git /tmp/spring-boot-react-mysql",
      "cd /tmp/spring-boot-react-mysql/spring-boot-server",

      "mvn package",
      "sudo systemctl disable --now mysql",

      "sudo cp ./target/spring-boot-data-jpa-0.0.1-SNAPSHOT.jar ./src/main/resources/application.properties /opt/bezkoder-backend",
      "ls -la /opt/bezkoder-backend"
    ]
  }


  provisioner "file" {
    source      = "bezkoder-backend.service"
    destination = "/tmp/bezkoder-backend.service"
  }

  provisioner "shell" {
    inline = [
      "sudo mv /tmp/bezkoder-backend.service /etc/systemd/system/bezkoder-backend.service"
    ]
  }
}
